# System Architecture Diagram

## Complete JWT Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT APPLICATION                          â”‚
â”‚                    (React Native / Expo / Web)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Google     â”‚    â”‚  Token Manager  â”‚    â”‚   Secure        â”‚  â”‚
â”‚  â”‚   Sign-In    â”‚â”€â”€â”€â–¶â”‚  - Store tokens â”‚â”€â”€â”€â–¶â”‚   Storage       â”‚  â”‚
â”‚  â”‚   Button     â”‚    â”‚  - Auto refresh â”‚    â”‚  (SecureStore)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  - API calls    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                              â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ HTTPS
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FASTIFY SERVER                              â”‚
â”‚                      (Node.js + TypeScript)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MIDDLEWARE LAYER                        â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â€¢ CORS Handler                                            â”‚   â”‚
â”‚  â”‚  â€¢ Cookie Parser                                           â”‚   â”‚
â”‚  â”‚  â€¢ JWT Verifier                                            â”‚   â”‚
â”‚  â”‚  â€¢ Authentication Middleware (authenticate)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      ROUTE LAYER                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  Auth Routes (/auth/*)                                     â”‚   â”‚
â”‚  â”‚    â€¢ POST /auth/google    - Login                          â”‚   â”‚
â”‚  â”‚    â€¢ POST /auth/refresh   - Refresh tokens                 â”‚   â”‚
â”‚  â”‚    â€¢ GET  /auth/me        - Get user (ğŸ”’)                  â”‚   â”‚
â”‚  â”‚    â€¢ POST /auth/logout    - Logout                         â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Task Routes (/tasks/*)                                    â”‚   â”‚
â”‚  â”‚    â€¢ GET    /tasks        - List tasks (ğŸ”’)                â”‚   â”‚
â”‚  â”‚    â€¢ POST   /tasks        - Create task (ğŸ”’)               â”‚   â”‚
â”‚  â”‚    â€¢ PATCH  /tasks/:id    - Update task (ğŸ”’)               â”‚   â”‚
â”‚  â”‚    â€¢ DELETE /tasks/:id    - Delete task (ğŸ”’)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SERVICE LAYER                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  AuthService                                               â”‚   â”‚
â”‚  â”‚    â€¢ verifyGoogleToken()                                   â”‚   â”‚
â”‚  â”‚    â€¢ findOrCreateUser()                                    â”‚   â”‚
â”‚  â”‚    â€¢ generateRefreshToken()                                â”‚   â”‚
â”‚  â”‚    â€¢ verifyRefreshToken()                                  â”‚   â”‚
â”‚  â”‚    â€¢ revokeRefreshToken()                                  â”‚   â”‚
â”‚  â”‚    â€¢ cleanupExpiredTokens()                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   DATABASE LAYER (Prisma)                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â€¢ Type-safe queries                                       â”‚   â”‚
â”‚  â”‚  â€¢ Migrations                                              â”‚   â”‚
â”‚  â”‚  â€¢ Connection pooling                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      POSTGRESQL DATABASE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    User      â”‚    â”‚ RefreshToken â”‚    â”‚     Task     â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ id           â”‚â—€â”€â”€â”€â”‚ userId       â”‚    â”‚ id           â”‚        â”‚
â”‚  â”‚ googleId     â”‚    â”‚ token        â”‚    â”‚ title        â”‚        â”‚
â”‚  â”‚ email        â”‚    â”‚ expiresAt    â”‚    â”‚ description  â”‚        â”‚
â”‚  â”‚ name         â”‚    â”‚ revoked      â”‚â—€â”€â”€â”€â”‚ userId       â”‚        â”‚
â”‚  â”‚ avatar       â”‚    â”‚ createdAt    â”‚    â”‚ completed    â”‚        â”‚
â”‚  â”‚ lastLogin    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ createdAt    â”‚        â”‚
â”‚  â”‚ createdAt    â”‚                        â”‚ updatedAt    â”‚        â”‚
â”‚  â”‚ updatedAt    â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â–²
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GOOGLE OAUTH SERVICE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Verify ID tokens                                                 â”‚
â”‚  â€¢ Validate email verification                                      â”‚
â”‚  â€¢ Validate token issuer                                            â”‚
â”‚  â€¢ Return user profile data                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Authentication Flow Sequence

```
User                Client              Server              Database         Google
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚  1. Click Login    â”‚                    â”‚                    â”‚              â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚  2. Google Sign-In â”‚                    â”‚              â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚  3. ID Token       â”‚                    â”‚              â”‚
 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚  4. POST /auth/google                   â”‚              â”‚
 â”‚                    â”‚       {idToken}    â”‚                    â”‚              â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  5. Verify Token   â”‚              â”‚
 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  6. User Data      â”‚              â”‚
 â”‚                    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  7. Find/Create User              â”‚
 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  8. User Record    â”‚              â”‚
 â”‚                    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  9. Create Refresh Token          â”‚
 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚  10. Tokens        â”‚                    â”‚              â”‚
 â”‚                    â”‚  {token, refresh}  â”‚                    â”‚              â”‚
 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚  11. Store Tokens  â”‚                    â”‚              â”‚
 â”‚                    â”‚  (SecureStore)     â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚  12. Show App      â”‚                    â”‚                    â”‚              â”‚
 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚  13. Use App       â”‚                    â”‚                    â”‚              â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚  14. API Request   â”‚                    â”‚              â”‚
 â”‚                    â”‚  Authorization:    â”‚                    â”‚              â”‚
 â”‚                    â”‚  Bearer {token}    â”‚                    â”‚              â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  15. Verify JWT    â”‚              â”‚
 â”‚                    â”‚                    â”‚  (Middleware)      â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  16. Check User    â”‚              â”‚
 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  17. User Exists   â”‚              â”‚
 â”‚                    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  18. Execute Query â”‚              â”‚
 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚  19. Data          â”‚              â”‚
 â”‚                    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚                    â”‚  20. Response      â”‚                    â”‚              â”‚
 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚              â”‚
 â”‚                    â”‚                    â”‚                    â”‚              â”‚
 â”‚  21. Display Data  â”‚                    â”‚                    â”‚              â”‚
 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚              â”‚
```

## Token Refresh Flow

```
Client              Server              Database
  â”‚                    â”‚                    â”‚
  â”‚  1. Access Token   â”‚                    â”‚
  â”‚     Expired        â”‚                    â”‚
  â”‚                    â”‚                    â”‚
  â”‚  2. POST /auth/refresh                  â”‚
  â”‚     {refreshToken} â”‚                    â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
  â”‚                    â”‚                    â”‚
  â”‚                    â”‚  3. Verify Refresh Token
  â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                    â”‚                    â”‚
  â”‚                    â”‚  4. Token Valid    â”‚
  â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                    â”‚                    â”‚
  â”‚                    â”‚  5. Revoke Old Token
  â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                    â”‚                    â”‚
  â”‚                    â”‚  6. Create New Token
  â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                    â”‚                    â”‚
  â”‚                    â”‚  7. New Token ID   â”‚
  â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                    â”‚                    â”‚
  â”‚  8. New Tokens     â”‚                    â”‚
  â”‚  {token, refresh}  â”‚                    â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
  â”‚                    â”‚                    â”‚
  â”‚  9. Update Storage â”‚                    â”‚
  â”‚                    â”‚                    â”‚
```

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY LAYERS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Layer 1: HTTPS/TLS                                         â”‚
â”‚  â”œâ”€ Encrypted communication                                 â”‚
â”‚  â””â”€ Prevents man-in-the-middle attacks                      â”‚
â”‚                                                             â”‚
â”‚  Layer 2: CORS                                              â”‚
â”‚  â”œâ”€ Controlled origins                                      â”‚
â”‚  â””â”€ Prevents unauthorized domains                           â”‚
â”‚                                                             â”‚
â”‚  Layer 3: Google OAuth                                      â”‚
â”‚  â”œâ”€ Verified ID tokens                                      â”‚
â”‚  â”œâ”€ Email verification check                                â”‚
â”‚  â””â”€ Issuer validation                                       â”‚
â”‚                                                             â”‚
â”‚  Layer 4: JWT Tokens                                        â”‚
â”‚  â”œâ”€ Short-lived access tokens (15 min)                      â”‚
â”‚  â”œâ”€ Signed with secret                                      â”‚
â”‚  â””â”€ Type validation (access vs refresh)                     â”‚
â”‚                                                             â”‚
â”‚  Layer 5: Refresh Token Rotation                            â”‚
â”‚  â”œâ”€ One-time use tokens                                     â”‚
â”‚  â”œâ”€ Database-backed revocation                              â”‚
â”‚  â””â”€ Expiry tracking                                         â”‚
â”‚                                                             â”‚
â”‚  Layer 6: Middleware Authentication                         â”‚
â”‚  â”œâ”€ JWT verification                                        â”‚
â”‚  â”œâ”€ User existence check                                    â”‚
â”‚  â””â”€ Request user attachment                                 â”‚
â”‚                                                             â”‚
â”‚  Layer 7: Resource Authorization                            â”‚
â”‚  â”œâ”€ Ownership verification                                  â”‚
â”‚  â”œâ”€ User isolation                                          â”‚
â”‚  â””â”€ Input validation                                        â”‚
â”‚                                                             â”‚
â”‚  Layer 8: Database Security                                 â”‚
â”‚  â”œâ”€ Parameterized queries (Prisma)                          â”‚
â”‚  â”œâ”€ Connection pooling                                      â”‚
â”‚  â””â”€ Cascade deletion                                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Structure & Responsibilities

```
server/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                    # Server setup & plugin registration
â”‚   â”‚   â”œâ”€ Fastify instance
â”‚   â”‚   â”œâ”€ CORS configuration
â”‚   â”‚   â”œâ”€ JWT plugin
â”‚   â”‚   â”œâ”€ Cookie plugin
â”‚   â”‚   â””â”€ Route registration
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.ts                 # Authentication logic
â”‚   â”‚       â”œâ”€ authenticate()       # Verify JWT & attach user
â”‚   â”‚       â””â”€ optionalAuthenticate() # Optional auth
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.ts                 # Authentication endpoints
â”‚   â”‚   â”‚   â”œâ”€ POST /auth/google    # Login with Google
â”‚   â”‚   â”‚   â”œâ”€ POST /auth/refresh   # Refresh tokens
â”‚   â”‚   â”‚   â”œâ”€ POST /auth/logout    # Logout & revoke
â”‚   â”‚   â”‚   â”œâ”€ GET  /auth/me        # Get current user
â”‚   â”‚   â”‚   â””â”€ POST /auth/verify    # Verify token
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ tasks.ts                # Task CRUD endpoints
â”‚   â”‚       â”œâ”€ GET    /tasks        # List all tasks
â”‚   â”‚       â”œâ”€ GET    /tasks/:id    # Get specific task
â”‚   â”‚       â”œâ”€ POST   /tasks        # Create task
â”‚   â”‚       â”œâ”€ PATCH  /tasks/:id    # Update task
â”‚   â”‚       â””â”€ DELETE /tasks/:id    # Delete task
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ authService.ts          # Business logic
â”‚   â”‚       â”œâ”€ verifyGoogleToken()
â”‚   â”‚       â”œâ”€ findOrCreateUser()
â”‚   â”‚       â”œâ”€ generateRefreshToken()
â”‚   â”‚       â”œâ”€ verifyRefreshToken()
â”‚   â”‚       â”œâ”€ revokeRefreshToken()
â”‚   â”‚       â””â”€ cleanupExpiredTokens()
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ prisma.ts               # Prisma client singleton
â”‚   â”‚
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ fastify.d.ts            # TypeScript type extensions
â”‚
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma               # Database schema
â”‚   â”‚   â”œâ”€ User model
â”‚   â”‚   â”œâ”€ RefreshToken model
â”‚   â”‚   â””â”€ Task model
â”‚   â”‚
â”‚   â””â”€â”€ migrations/                 # Database migrations
â”‚
â””â”€â”€ examples/
    â”œâ”€â”€ tokenManager.ts             # Client-side utility
    â””â”€â”€ ReactNativeExample.tsx      # Full client example
```

ğŸ”’ = Protected endpoint (requires authentication)
